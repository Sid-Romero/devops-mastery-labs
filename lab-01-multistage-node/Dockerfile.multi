# Stage 1 : builder (compile native modules, install deps)
FROM node:20-slim AS builder
WORKDIR /usr/src/app

# copy manifest files
COPY package*.json ./
RUN npm ci --omit=dev

# copy the rest
COPY . .


# Stage 2 : runtime (clean, without build tools)
FROM node:20-slim AS runtime
WORKDIR /usr/src/app

# copy app files + node_modules from builder
COPY --from=builder /usr/src/app /usr/src/app

# run as non-root user
USER node

EXPOSE 8080
CMD ["node", "server.js"]
